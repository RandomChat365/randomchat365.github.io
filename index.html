<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Random Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar Style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5; /* indigo-600 */
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4338ca; /* indigo-700 */
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default, controlled by JS */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            align-items: center; /* For flexbox centering */
            justify-content: center; /* For flexbox centering */
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-100 flex flex-col items-center justify-center p-4">

    <div id="app-container" class="w-full max-w-md bg-gray-800 rounded-lg shadow-xl p-6 flex flex-col h-[80vh] sm:h-[70vh]">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-400">Live Random Chat</h1>

        <div id="userInfoSection" class="text-sm text-gray-400 text-center mb-4">
            <span id="userIdDisplay" class="font-mono text-indigo-300 hidden"></span>
            </div>

        <div id="nicknameSection" class="flex-grow flex items-center justify-center flex-col p-4 space-y-4">
            <label for="nicknameInput" class="text-lg text-gray-300">Choose your nickname:</label>
            <input type="text" id="nicknameInput" placeholder="Stranger" maxlength="20"
                   class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-400 text-center" />
            <button id="setNicknameButton"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Start Chat
            </button>
            <p id="waitingMessage" class="text-gray-400 mt-4 hidden">Finding a stranger...</p>
        </div>


        <div id="chatSection" class="hidden flex-grow flex flex-col">
            <div id="messagesContainer" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-700 rounded-lg mb-4 custom-scrollbar">
                </div>

            <div class="flex gap-2 mb-2">
                 <button id="requestPhotoButton"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-800 flex-none">
                    Request Photo
                </button>
                <button id="reportButton"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md text-sm transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 focus:ring-offset-gray-800 flex-none">
                    Report
                </button>
            </div>

            <form id="messageForm" class="flex gap-2 mb-4">
                <input type="text" id="messageInput" placeholder="Type your message..."
                    class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-400" />
                <button type="submit" id="sendMessageButton"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-5 rounded-lg shadow-md transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                    Send
                </button>
            </form>

            <button id="nextChatButton"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                End & Next Chat
            </button>
        </div>
    </div>

    <div id="ageConfirmationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-white">Confirm Your Age</h2>
            <p class="text-gray-300 mb-6">By clicking "Confirm", you assert that you are 18 years or older and agree to our terms.</p>
            <button id="confirmAgeButton"
                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 mr-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Confirm
            </button>
            <button id="cancelAgeButton"
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Cancel
            </button>
        </div>
    </div>

    <div id="skipChatConfirmationModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-white">End Current Chat?</h2>
            <p class="text-gray-300 mb-6">Are you sure you want to end this chat and find a new partner?</p>
            <button id="confirmSkipButton"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 mr-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Confirm
            </button>
            <button id="cancelSkipButton"
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Cancel
            </button>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-white">Report User</h2>
            <p class="text-gray-300 mb-4">Please select a reason for reporting:</p>
            <select id="reportReason"
                    class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="Inappropriate Content">Inappropriate Content</option>
                <option value="Harassment">Harassment</option>
                <option value="Spam">Spam</option>
                <option value="Other">Other</option>
            </select>
            <textarea id="reportDetails" rows="3" placeholder="Provide more details (optional)"
                      class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 mb-6 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
            <button id="submitReportButton"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 mr-2 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Submit Report
            </button>
            <button id="cancelReportButton"
                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 focus:outline-none focus:ring-2 focus="ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                Cancel
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // Global variables for Firebase instances and user state
        let app;
        let db;
        let auth;
        let storage; // Firebase Storage instance
        let userId = null;
        let userNickname = "Stranger"; // Default nickname
        let currentChatId = null; // ID of the current chat document
        let chatUnsubscribe = null; // To unsubscribe from chat messages listener
        let userStatusUnsubscribe = null; // To unsubscribe from user status listener
        let appId; // Global variable for the application ID
        let messages = []; // Correctly defined globally here
        let isAgeConfirmed = false;

        // DOM Elements
        const userInfoSection = document.getElementById('userInfoSection'); // New container for user info
        const userIdDisplay = document.getElementById('userIdDisplay'); // This will eventually show nickname
        const nicknameSection = document.getElementById('nicknameSection');
        const nicknameInput = document.getElementById('nicknameInput');
        const setNicknameButton = document.getElementById('setNicknameButton');
        const waitingMessage = document.getElementById('waitingMessage');
        const chatSection = document.getElementById('chatSection');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const nextChatButton = document.getElementById('nextChatButton'); // This now acts as "End & Next Chat"
        const requestPhotoButton = document.getElementById('requestPhotoButton');
        const reportButton = document.getElementById('reportButton');

        // Modal Elements
        const ageConfirmationModal = document.getElementById('ageConfirmationModal');
        const confirmAgeButton = document.getElementById('confirmAgeButton');
        const cancelAgeButton = document.getElementById('cancelAgeButton');

        const skipChatConfirmationModal = document.getElementById('skipChatConfirmationModal');
        const confirmSkipButton = document.getElementById('confirmSkipButton');
        const cancelSkipButton = document.getElementById('cancelSkipButton');

        const reportModal = document.getElementById('reportModal');
        const reportReason = document.getElementById('reportReason');
        const reportDetails = document.getElementById('reportDetails');
        const submitReportButton = document.getElementById('submitReportButton');
        const cancelReportButton = document.getElementById('cancelReportButton');


        // Firestore collection paths (public data as per instructions)
        let CHATS_COLLECTION_PATH;
        let USERS_ONLINE_COLLECTION_PATH;
        let REPORTS_COLLECTION_PATH; // New collection for reports

        // Function to scroll to the bottom of the chat window
        const scrollToBottom = () => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        // Function to render messages in the UI
        const renderMessages = () => {
            messagesContainer.innerHTML = ''; // Clear existing messages
            if (messages.length === 0 && currentChatId) {
                const initialMessage = document.createElement('p');
                initialMessage.className = 'text-center text-gray-400 italic';
                initialMessage.innerHTML = `You've connected with a chat partner. Say hello!`;
                messagesContainer.appendChild(initialMessage);
            }

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                let alignmentClass = '';
                let bubbleClass = '';
                let senderLabel = '';

                // Get the nickname from the message if available, otherwise default
                const displayNickname = msg.senderNickname || 'Stranger';

                if (msg.senderId === userId) {
                    alignmentClass = 'justify-end';
                    bubbleClass = 'bg-indigo-500 text-white rounded-br-none';
                    senderLabel = 'You'; // Always "You" for the local user
                } else {
                    alignmentClass = 'justify-start';
                    bubbleClass = 'bg-gray-600 text-gray-100 rounded-bl-none';
                    senderLabel = displayNickname; // Use the received nickname for the partner
                }

                messageDiv.className = `flex ${alignmentClass}`;

                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-[70%] p-3 rounded-lg shadow-md ${bubbleClass}`;

                const senderSpan = document.createElement('span');
                senderSpan.className = 'block text-xs font-bold mb-1 opacity-80';
                senderSpan.textContent = senderLabel;

                messageBubble.appendChild(senderSpan);

                // Handle different message types (text, photo, photo request)
                if (msg.type === 'image') {
                    const img = document.createElement('img');
                    img.src = msg.imageUrl;
                    img.alt = 'Shared Image';
                    img.className = 'max-w-full h-auto rounded-md mt-1';
                    messageBubble.appendChild(img);
                    const caption = document.createElement('p');
                    caption.className = 'text-sm mt-1';
                    caption.textContent = msg.text || 'Image shared.'; // Use text as caption
                    messageBubble.appendChild(caption);
                } else if (msg.type === 'photo_request') {
                    const requestText = document.createElement('p');
                    requestText.className = 'text-sm italic text-gray-300';
                    requestText.textContent = msg.senderId === userId ? "You requested a photo." : `${senderLabel} requested a photo.`;
                    messageBubble.appendChild(requestText);

                    if (msg.senderId !== userId) { // Only show 'Share Photo' button to the recipient
                        const shareButton = document.createElement('button');
                        shareButton.textContent = "Share Photo";
                        shareButton.className = "mt-2 bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-md focus:outline-none focus:ring-2 focus:ring-green-400";
                        shareButton.onclick = () => handleSharePhoto(msg.id); // Pass message ID for potential tracking
                        messageBubble.appendChild(shareButton);
                    }
                }
                else {
                    const messageText = document.createElement('p');
                    messageText.className = 'text-sm';
                    messageText.textContent = msg.text;
                    messageBubble.appendChild(messageText);
                }


                const messageTimestamp = document.createElement('span');
                messageTimestamp.className = 'block text-xs text-right mt-1 opacity-75';
                messageTimestamp.textContent = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });


                messageBubble.appendChild(messageTimestamp);
                messageDiv.appendChild(messageBubble);
                messagesContainer.appendChild(messageDiv);
            });
            scrollToBottom();
        };

        // Function to update user's online status in Firestore (including nickname)
        const updateUserOnlineStatus = async (status) => {
            if (!userId || !db || !USERS_ONLINE_COLLECTION_PATH) return;
            const userDocRef = doc(db, USERS_ONLINE_COLLECTION_PATH, userId);
            try {
                if (status === 'online') {
                    await setDoc(userDocRef, { timestamp: Date.now(), nickname: userNickname || "Stranger" });
                } else if (status === 'offline') {
                    await deleteDoc(userDocRef);
                }
            } catch (error) {
                console.error("Error updating user online status:", error);
            }
        };

        // Function to end the current chat
        const endCurrentChat = async () => {
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            if (userStatusUnsubscribe) {
                userStatusUnsubscribe();
                userStatusUnsubscribe = null;
            }
            if (currentChatId) {
                try {
                    const chatDocRef = doc(db, CHATS_COLLECTION_PATH, currentChatId);
                    await updateDoc(chatDocRef, { status: 'ended' });
                } catch (error) {
                    console.error("Error ending chat:", error);
                }
            }
            currentChatId = null;
            messages = []; // Clear messages array
            renderMessages(); // Clear messages from UI

            // Reset UI to nickname entry
            nicknameSection.classList.remove('hidden');
            waitingMessage.classList.add('hidden');
            chatSection.classList.add('hidden');
            userInfoSection.classList.add('hidden'); // Hide user info during setup
            setNicknameButton.textContent = 'Start Chat'; // Ensure button text is "Start Chat" for new session

            updateUserOnlineStatus('offline'); // Ensure user is removed from online list
        };

        // Function to find or create a chat
        const findOrCreateChat = async () => {
            if (!userId || !db || !CHATS_COLLECTION_PATH || !USERS_ONLINE_COLLECTION_PATH) {
                console.error("Firebase not initialized or userId not set.");
                return;
            }
            if (!isAgeConfirmed) {
                ageConfirmationModal.style.display = 'flex'; // Show modal using flex for centering
                return;
            }

            endCurrentChat(); // Clear previous chat state and reset UI to base before searching

            nicknameSection.classList.add('hidden');
            userInfoSection.classList.add('hidden'); // Hide info during waiting
            waitingMessage.classList.remove('hidden'); // Show "Finding stranger..."
            chatSection.classList.add('hidden');
            setNicknameButton.textContent = 'Finding Stranger...'; // Update button text temporarily


            try {
                // First, try to find an active partner in the `users_online` collection
                // We're looking for ANY user online, excluding ourselves.
                const usersOnlineRef = collection(db, USERS_ONLINE_COLLECTION_PATH);
                const q = query(usersOnlineRef, limit(1)); // Just get one
                const onlineUsersSnapshot = await getDocs(q);

                let foundPartnerId = null;
                let foundPartnerNickname = null;

                for (const docSnapshot of onlineUsersSnapshot.docs) {
                    if (docSnapshot.id !== userId) { // Don't match with self
                        foundPartnerId = docSnapshot.id;
                        foundPartnerNickname = docSnapshot.data().nickname || 'Stranger';
                        break;
                    }
                }

                if (foundPartnerId) {
                    // Found a partner, create a new chat document
                    const newChatRef = await addDoc(collection(db, CHATS_COLLECTION_PATH), {
                        users: {
                            [userId]: userNickname,
                            [foundPartnerId]: foundPartnerNickname
                        },
                        createdAt: Date.now(),
                        status: 'active'
                    });
                    currentChatId = newChatRef.id;

                    // Immediately remove both users from the online waiting list
                    await deleteDoc(doc(db, USERS_ONLINE_COLLECTION_PATH, foundPartnerId));
                    await deleteDoc(doc(db, USERS_ONLINE_COLLECTION_PATH, userId));

                    startListeningToChat();

                } else {
                    // No partner found, add self to waiting list
                    await updateUserOnlineStatus('online'); // This adds us to `users_online` with our nickname
                    waitingMessage.textContent = "Finding a stranger...";

                    // Listen for incoming chats that include this user
                    const chatsRef = collection(db, CHATS_COLLECTION_PATH);
                    const qUserChats = query(
                        chatsRef,
                        where(`users.${userId}`, "!=", null), // Check if our UID exists as a key in the 'users' map
                        where("status", "==", "active")
                    );

                    chatUnsubscribe = onSnapshot(qUserChats, (snapshot) => {
                        snapshot.docChanges().forEach(async (change) => {
                            if (change.type === 'added' || (change.type === 'modified' && change.doc.data().status === 'active')) {
                                const chatData = change.doc.data();
                                if (chatData.users.hasOwnProperty(userId)) { // Double-check we are part of this chat
                                    currentChatId = change.doc.id;
                                    startListeningToChat();
                                    // Once a chat is established, ensure we are removed from the waiting list
                                    await updateUserOnlineStatus('offline');
                                    if (userStatusUnsubscribe) {
                                        userStatusUnsubscribe();
                                        userStatusUnsubscribe = null; // Stop listening to online users
                                    }
                                }
                            } else if (change.type === 'modified' && change.doc.data().status === 'ended' && change.doc.id === currentChatId) {
                                // If current chat is marked as ended by partner
                                endCurrentChat(); // This will trigger a new search if the user initiated it
                            }
                        });
                    });
                }
            } catch (error) {
                console.error("Error finding or creating chat:", error);
                waitingMessage.textContent = "Error finding partner. Please try again.";
                nicknameSection.classList.remove('hidden'); // Show nickname input on error
                setNicknameButton.textContent = 'Start Chat'; // Reset button text
            }
        };

        // Function to start listening to chat messages
        const startListeningToChat = () => {
            if (!currentChatId || !db || !CHATS_COLLECTION_PATH) return;

            // Unsubscribe from any previous chat listener
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            // Unsubscribe from user status listener if active (from waiting)
            if (userStatusUnsubscribe) {
                userStatusUnsubscribe();
                userStatusUnsubscribe = null;
            }

            // Hide waiting message, show chat section
            waitingMessage.classList.add('hidden');
            nicknameSection.classList.add('hidden'); // Hide nickname input
            chatSection.classList.remove('hidden');
            userInfoSection.classList.remove('hidden'); // Show user info (nickname)
            userIdDisplay.textContent = `You are: ${userNickname}`;
            userIdDisplay.classList.remove('hidden');


            nextChatButton.textContent = 'End & Next Chat'; // Button text for active chat

            // Listen for messages in the current chat
            const messagesRef = collection(db, CHATS_COLLECTION_PATH, currentChatId, 'messages');
            chatUnsubscribe = onSnapshot(query(messagesRef), (snapshot) => {
                const newMessages = [];
                snapshot.forEach(doc => {
                    newMessages.push({ id: doc.id, ...doc.data() });
                });
                // Sort messages by timestamp to ensure correct order
                messages = newMessages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages();
            }, (error) => {
                console.error("Error listening to messages:", error);
                // Handle chat ending due to error, maybe go back to start screen
                endCurrentChat();
            });
        };

        // Function to send a message
        const sendMessage = async (e) => {
            e.preventDefault();
            const inputVal = messageInput.value.trim();
            if (inputVal && currentChatId && userId) {
                try {
                    const messagesRef = collection(db, CHATS_COLLECTION_PATH, currentChatId, 'messages');
                    await addDoc(messagesRef, {
                        text: inputVal,
                        senderId: userId,
                        senderNickname: userNickname, // Include nickname
                        timestamp: Date.now(),
                        type: 'text' // Add message type
                    });
                    messageInput.value = ''; // Clear input field
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }
        };

        // Function to handle photo request
        const requestPhoto = async () => {
            if (currentChatId && userId) {
                try {
                    const messagesRef = collection(db, CHATS_COLLECTION_PATH, currentChatId, 'messages');
                    await addDoc(messagesRef, {
                        text: `${userNickname} requested a photo.`,
                        senderId: userId,
                        senderNickname: userNickname,
                        timestamp: Date.now(),
                        type: 'photo_request'
                    });
                } catch (error) {
                    console.error("Error sending photo request:", error);
                }
            } else {
                alert("You must be in a chat to request a photo.");
            }
        };

        // Function to handle sharing a photo (triggered by "Share Photo" button)
        const handleSharePhoto = async (messageId) => {
            if (!currentChatId || !userId || !storage) {
                alert("Cannot share photo: Not in a chat or storage not initialized.");
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*'; // Accept only image files
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const storageRef = ref(storage, `chat_images/${currentChatId}/${userId}/${Date.now()}_${file.name}`);
                        const uploadTask = uploadBytesResumable(storageRef, file);

                        uploadTask.on('state_changed',
                            (snapshot) => {
                                // Optional: monitor upload progress
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                console.log('Upload is ' + progress + '% done');
                            },
                            (error) => {
                                console.error("Image upload failed:", error);
                                alert("Failed to upload image.");
                            },
                            async () => {
                                // Upload complete, get the download URL
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                console.log('File available at', downloadURL);

                                // Send the image URL as a message
                                const messagesRef = collection(db, CHATS_COLLECTION_PATH, currentChatId, 'messages');
                                await addDoc(messagesRef, {
                                    text: 'Shared a photo.',
                                    imageUrl: downloadURL,
                                    senderId: userId,
                                    senderNickname: userNickname,
                                    timestamp: Date.now(),
                                    type: 'image' // Mark as image message
                                });
                            }
                        );
                    } catch (error) {
                        console.error("Error uploading image:", error);
                        alert("Error uploading image.");
                    }
                }
            };
            input.click(); // Programmatically click the file input
        };


        // Function to submit a report
        const submitReport = async () => {
            if (!currentChatId || !userId) {
                alert("Cannot submit report: Not in a chat or user not identified.");
                return;
            }

            const reason = reportReason.value;
            const details = reportDetails.value.trim();

            if (!reason) {
                alert("Please select a reason for the report.");
                return;
            }

            try {
                const reportsRef = collection(db, REPORTS_COLLECTION_PATH);
                await addDoc(reportsRef, {
                    reporterId: userId,
                    reportedChatId: currentChatId,
                    reason: reason,
                    details: details,
                    timestamp: serverTimestamp() // Use server timestamp for accuracy
                });
                alert("Report submitted successfully.");
                reportModal.style.display = 'none'; // Hide modal
                reportDetails.value = ''; // Clear details
                reportReason.value = 'Inappropriate Content'; // Reset dropdown
            } catch (error) {
                console.error("Error submitting report:", error);
                alert("Failed to submit report. Please try again.");
            }
        };

        // Event Listeners
        setNicknameButton.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            userNickname = nickname === "" ? "Stranger" : nickname; // Set default if empty
            // userIdDisplay.textContent = `You are: ${userNickname}`; // Updated when chat starts
            findOrCreateChat(); // Initiate chat after setting nickname and age confirmation
        });

        // Age confirmation button handlers
        confirmAgeButton.addEventListener('click', () => {
            isAgeConfirmed = true;
            ageConfirmationModal.style.display = 'none'; // Hide modal
            findOrCreateChat(); // Re-attempt chat after confirmation
        });
        cancelAgeButton.addEventListener('click', () => {
            isAgeConfirmed = false;
            ageConfirmationModal.style.display = 'none'; // Hide modal
            // User cancelled age confirmation, so they can't proceed to chat
            nicknameSection.classList.remove('hidden');
            waitingMessage.classList.add('hidden');
            setNicknameButton.textContent = 'Start Chat'; // Reset button text
            userInfoSection.classList.add('hidden'); // Ensure info is hidden
        });


        // "End & Next Chat" button handler
        nextChatButton.addEventListener('click', () => {
            if (currentChatId) { // If currently in a chat, show confirmation
                skipChatConfirmationModal.style.display = 'flex'; // Show modal
            } else { // If not in a chat (e.g., after initial start), just find new
                findOrCreateChat();
            }
        });

        // Skip chat confirmation button handlers
        confirmSkipButton.addEventListener('click', () => {
            skipChatConfirmationModal.style.display = 'none'; // Hide modal
            findOrCreateChat(); // End current chat and find new
        });
        cancelSkipButton.addEventListener('click', () => {
            skipChatConfirmationModal.style.display = 'none'; // Hide modal
            // Do nothing, user decided not to skip
        });


        messageForm.addEventListener('submit', sendMessage);
        requestPhotoButton.addEventListener('click', requestPhoto);
        reportButton.addEventListener('click', () => reportModal.style.display = 'flex'); // Show modal
        submitReportButton.addEventListener('click', submitReport);
        cancelReportButton.addEventListener('click', () => reportModal.style.display = 'none'); // Hide modal


        // Firebase Initialization and Authentication
        window.onload = async function() {
            try {
                // Access global variables provided by the Canvas environment (if available)
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // YOUR FIREBASE CONFIGURATION
                const firebaseConfig = {
                    apiKey: "AIzaSyDm4xiubyMVvmp-l84h7GYIhWbsepfhToY",
                    authDomain: "randomchat365-e66a9.firebaseapp.com",
                    projectId: "randomchat365-e66a9",
                    storageBucket: "randomchat365-e66a9.firebasestorage.app",
                    messagingSenderId: "932355688919",
                    appId: "1:932355688919:web:54f01ecbc8891360c5e392",
                    measurementId: "G-NHB99TPWE5"
                };

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Initialize Firebase Storage

                // Define Firestore collection paths using appId
                CHATS_COLLECTION_PATH = `/artifacts/${appId}/public/data/chats`;
                USERS_ONLINE_COLLECTION_PATH = `/artifacts/${appId}/public/data/users_online`;
                REPORTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/reports`;

                // Hide modals initially (they are shown with JS explicitly)
                ageConfirmationModal.style.display = 'none';
                skipChatConfirmationModal.style.display = 'none';
                reportModal.style.display = 'none';


                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Display initial nickname or default 'Stranger'
                        // userIdDisplay.textContent = `User ID: ${userId}`; // This is hidden initially
                        // Show nickname input section
                        nicknameSection.classList.remove('hidden');
                        chatSection.classList.add('hidden');
                    } else {
                        try {
                            // Attempt anonymous sign-in
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            // userIdDisplay.textContent = 'Error getting User ID'; // This is hidden initially
                            alert("Failed to authenticate with Firebase. Please try again later.");
                        }
                    }
                });

                // Handle user leaving the page
                window.addEventListener('beforeunload', () => {
                    updateUserOnlineStatus('offline');
                    if (chatUnsubscribe) chatUnsubscribe();
                    if (userStatusUnsubscribe) userStatusUnsubscribe();
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // userIdDisplay.textContent = 'Error initializing Firebase'; // This is hidden initially
                alert("Failed to initialize Firebase. Please check your console for errors.");
            }
        };
    </script>
</body>
</html>
